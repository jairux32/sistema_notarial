version: '3.8'

services:
  # Base de datos PostgreSQL
  db:
    image: postgres:15-alpine
    container_name: notarial_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: sistema_notarial
      POSTGRES_USER: notarial_user
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme123}
    volumes:
      # Datos de PostgreSQL en disco externo
      - ${EXTERNAL_DISK_PATH:-/mnt/external}/postgres_data:/var/lib/postgresql/data
      # Script de inicialización
      - ./init_db.sql:/docker-entrypoint-initdb.d/init_db.sql
    ports:
      - "5432:5432"
    networks:
      - notarial_network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U notarial_user -d sistema_notarial" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Aplicación principal
  app:
    build: .
    container_name: notarial_app
    restart: unless-stopped
    # Usar red del host para acceder al escáner en la LAN
    network_mode: host

    # ports: (Ignorado en modo host, el puerto 5000 se abre directo)
    #   - "5000:5000"

    environment:
      # Configuración de Flask
      FLASK_ENV: production
      SECRET_KEY: ${SECRET_KEY:-your-secret-key-change-this}

      # Configuración de base de datos
      # Al usar network_mode: host, accedemos a la DB via localhost (puerto expuesto del contenedor db)
      DATABASE_URL: postgresql://notarial_user:${DB_PASSWORD:-changeme123}@localhost:5432/sistema_notarial

      # Configuración de rutas (dentro del contenedor)
      UPLOAD_FOLDER: /data/uploads
      PROCESSED_FOLDER: /data/processed
      SCANNED_FOLDER: /data/scanned
      SCANNED_ARCHIVE_FOLDER: /data/scanned_archive
      SCANNED_PREVIEW_FOLDER: /data/scanned_preview
      ESCANEO_SEPARADO_FOLDER: /data/escaneo_separado

      # Configuración Tesseract
      TESSDATA_PREFIX: /usr/share/tesseract-ocr/4.00/tessdata

      # URL del servicio de escaneo en el Host
      # Servicio de escáner corre localmente dentro del contenedor
      SCANNER_SERVICE_URL: http://localhost:5001
      # IP del escáner en la red
      SCANNER_IP_ADDRESS: 192.168.1.28

      # Timezone
      TZ: America/Bogota

    volumes:
      - .:/app
      - ${EXTERNAL_DISK_PATH}:/data
      # Mapeo DIRECTO de la carpeta de escaneo local
      # Esto permite que Docker vea los archivos que el Host guarda en ./scanned
      - ./scanned:/data/scanned

      # Logs en disco externo
      - ${EXTERNAL_DISK_PATH:-/mnt/external}/logs:/app/logs

    extra_hosts:
      - "host.docker.internal:host-gateway"

    privileged: false

    # Permisos para acceder al escáner
    group_add:
      - scanner

    depends_on:
      db:
        condition: service_healthy

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  notarial_network:
    driver: bridge
